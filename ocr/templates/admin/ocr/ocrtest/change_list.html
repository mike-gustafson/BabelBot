{% extends "admin/change_list.html" %}

{% block content %}
{% if show_test_form %}
<div class="ocr-test-container">
    <h2>OCR Test</h2>
    <form id="ocr-test-form" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="image">Select Image:</label>
            <input type="file" id="image" name="image" accept="image/*" required class="form-input bg-secondary text-primary">
        </div>
        <button type="submit" class="button">Process Image</button>
    </form>
    <div id="result-container" style="display: none;">
        <h3>Result:</h3>
        <div id="result-text" class="text-primary"></div>
    </div>
</div>

<style>
.ocr-test-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 4px;
    box-shadow: var(--shadow-color);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--text-primary);
}

.form-input {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    min-height: 36px;
}

.form-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px var(--shadow-color);
}

.button {
    background: var(--primary);
    color: var(--bg-primary);
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.button:hover {
    background: var(--accent);
}

#result-container {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    color: var(--text-primary);
}

#result-text {
    white-space: pre-wrap;
    word-break: break-word;
}
</style>

<script>
document.getElementById('ocr-test-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const resultContainer = document.getElementById('result-container');
    const resultText = document.getElementById('result-text');
    
    submitButton.disabled = true;
    submitButton.textContent = 'Processing...';
    
    const formData = new FormData(form);
    
    fetch('test/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultText.textContent = data.result.full_text;
            resultContainer.style.display = 'block';
            // Reload the page to show the new record
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.textContent = 'Process Image';
    });
});
</script>
{% endif %}

{{ block.super }}
{% endblock %} 