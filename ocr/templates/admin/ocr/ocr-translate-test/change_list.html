{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
    {% if show_test_form %}
    <div class="ocr-test-container">
        <h2>OCR and Translation Test</h2>
        
        <!-- OCR Section -->
        <div class="test-section">
            <h3>OCR Test</h3>
            <form id="ocr-test-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="image">Select Image:</label>
                    <input type="file" id="image" name="image" accept="image/*" required>
                </div>
                <button type="submit" class="button">Process Image</button>
            </form>
            <div id="ocr-result-container" style="display: none;">
                <h4>OCR Result:</h4>
                <div id="ocr-result-text"></div>
            </div>
        </div>

        <!-- Translation Section -->
        <div class="test-section">
            <h3>Translation</h3>
            <form id="translation-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="source_text">Source Text:</label>
                    <textarea id="source_text" name="source_text" rows="4" class="form-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="target_language">Target Language:</label>
                    <select id="target_language" name="target_language" class="form-input">
                        <option value="">Select a language</option>
                        {% for code, name in languages.items %}
                        <option value="{{ code }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="button">Translate</button>
            </form>
            <div id="translation-result-container" style="display: none;">
                <h4>Translation Result:</h4>
                <div id="translation-result-text"></div>
            </div>
        </div>
    </div>
    {% endif %}

    {{ block.super }}
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .ocr-test-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .test-section h3 {
            margin-top: 0;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .button {
            padding: 8px 16px;
            background: #79aec8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .button:hover {
            background: #609ab6;
        }

        #ocr-result-container,
        #translation-result-container {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #ocr-result-container h4,
        #translation-result-container h4 {
            margin-top: 0;
            color: #333;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // OCR Form Handling
            const ocrForm = document.getElementById('ocr-test-form');
            if (ocrForm) {
                ocrForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const submitButton = ocrForm.querySelector('button[type="submit"]');
                    const resultContainer = document.getElementById('ocr-result-container');
                    const resultText = document.getElementById('ocr-result-text');
                    
                    submitButton.disabled = true;
                    submitButton.textContent = 'Processing...';
                    
                    const formData = new FormData(ocrForm);
                    
                    fetch('test/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            resultText.textContent = data.result.full_text;
                            resultContainer.style.display = 'block';
                            // Update translation form with OCR result
                            document.getElementById('source_text').value = data.result.full_text;
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Process Image';
                    });
                });
            }

            // Translation Form Handling
            const translationForm = document.getElementById('translation-form');
            if (translationForm) {
                translationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const submitButton = translationForm.querySelector('button[type="submit"]');
                    const resultContainer = document.getElementById('translation-result-container');
                    const resultText = document.getElementById('translation-result-text');
                    
                    submitButton.disabled = true;
                    submitButton.textContent = 'Translating...';
                    
                    const formData = new FormData(translationForm);
                    
                    fetch('translate/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            resultText.textContent = data.result.translated_text;
                            resultContainer.style.display = 'block';
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Translate';
                    });
                });
            }
        });
    </script>
{% endblock %} 